I"¿$<blockquote>
  <p>ä»£ç å‚è€ƒ https://github.com/chenyuntc/simple-faster-rcnn-pytorch</p>
</blockquote>

<h1 id="æ¨¡å‹ç»“æ„å®ç°">æ¨¡å‹ç»“æ„å®ç°</h1>

<p>ç½‘ç»œç»“æ„éå¸¸ç®€å•ï¼Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªVGG16çš„backboneï¼Œç‰¹å¾æå–å±‚å¯¹åº”16å€é™é‡‡æ ·ã€‚ä¹‹åä¸€ä¸ªrpnåšobjectnesså’Œbboxçš„é¢„æµ‹ï¼Œå¾—åˆ°roiã€‚è¾“å…¥roi headï¼Œé¢„æµ‹å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚</p>

<p>å…·ä½“æ¨¡å—åœ¨ <strong>/model/</strong> ä¸­ã€‚</p>
<h1 id="è®­ç»ƒ">è®­ç»ƒ</h1>
<h2 id="loss">Loss</h2>

<p>ä¸Šè¿°ç½‘ç»œç»“æ„éƒ½æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å…³æ³¨ä¸€ä¸‹æºç ä¸­çš„lossæ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ä¸»è¦æ˜¯å¦‚ä½•é€šè¿‡gtè·å¾—è®­ç»ƒä½¿ç”¨çš„targetã€‚è®­ç»ƒéƒ¨åˆ†å†…å®¹åœ¨æºç  <strong>/trainer.py</strong>ä¸­ã€‚</p>

<p>å…·ä½“æ¥å…³æ³¨ä¸€ä¸‹ <strong>Faster RCNNä¸­è¿™äº›losså¯¹åº”çš„targetæ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Œä»¥åŠroiç­‰çš„å…·ä½“ä¼ é€’æ–¹å¼</strong></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<strong>FasterRCNNTrainer</strong>çš„forwardæ–¹æ³•å¦‚ä¸‹</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="s">"""Forward Faster R-CNN and calculate losses.

        Here are notations used.

        * :math:`N` is the batch size.
        * :math:`R` is the number of bounding boxes per image.

        Currently, only :math:`N=1` is supported.

        Args:
            imgs (~torch.autograd.Variable): A variable with a batch of images.
            bboxes (~torch.autograd.Variable): A batch of bounding boxes.
                Its shape is :math:`(N, R, 4)`.
            labels (~torch.autograd..Variable): A batch of labels.
                Its shape is :math:`(N, R)`. The background is excluded from
                the definition, which means that the range of the value
                is :math:`[0, L - 1]`. :math:`L` is the number of foreground
                classes.
            scale (float): Amount of scaling applied to
                the raw image during preprocessing.

        Returns:
            namedtuple of 5 losses
        """</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Currently only batch size 1 is supported.'</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">shape</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">faster_rcnn</span><span class="p">.</span><span class="n">extractor</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

        <span class="c1">#rpnåç§»é‡ï¼Œå¾—åˆ†ï¼Œroi(è§’åæ ‡)ï¼Œroiå¯¹åº”çš„å›¾ç‰‡(åœ¨batchä¸­çš„åºå·)ï¼Œanchor
</span>        <span class="n">rpn_locs</span><span class="p">,</span> <span class="n">rpn_scores</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">roi_indices</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="p">.</span><span class="n">faster_rcnn</span><span class="p">.</span><span class="n">rpn</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

        <span class="c1"># Since batch size is one, convert variables to singular form
</span>        <span class="c1"># è¿™é‡ŒæŒ‡å®šäº†batchsizeä¸º 1
</span>        <span class="n">bbox</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rpn_score</span> <span class="o">=</span> <span class="n">rpn_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rpn_loc</span> <span class="o">=</span> <span class="n">rpn_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">rois</span>

        <span class="c1"># Sample RoIs and forward
</span>        <span class="c1"># it's fine to break the computation graph of rois, 
</span>        <span class="c1"># consider them as constant input
</span>
        <span class="c1"># è¿”å›å€¼ roi æŒ‰æŒ‡å®šæ•°é‡å’Œæ¯”ä¾‹é‡‡æ ·çš„æ­£è´Ÿæ ·æœ¬ï¼Œå¯¹åº”çš„çœŸå€¼åç§»ï¼Œä»¥åŠä»–ä»¬çš„labelã€‚
</span>        <span class="c1"># è¿™é‡Œè®¡ç®—å‡ºæ¥çš„gtæ˜¯é’ˆå¯¹roiçš„åç§»å’Œæ ‡ç­¾ï¼Œå³è¿™æ˜¯å¯¹äºŒé˜¶æ®µå›å½’å’Œåˆ†ç±»çš„æ ‡ç­¾
</span>        <span class="n">sample_roi</span><span class="p">,</span> <span class="n">gt_roi_loc</span><span class="p">,</span> <span class="n">gt_roi_label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">proposal_target_creator</span><span class="p">(</span>
            <span class="n">roi</span><span class="p">,</span>
            <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">),</span>
            <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">loc_normalize_mean</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">loc_normalize_std</span><span class="p">)</span>
        <span class="c1"># NOTE it's all zero because now it only support for batch=1 now
</span>        <span class="n">sample_roi_index</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_roi</span><span class="p">))</span>
        <span class="n">roi_cls_loc</span><span class="p">,</span> <span class="n">roi_score</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">faster_rcnn</span><span class="p">.</span><span class="n">head</span><span class="p">(</span>
            <span class="n">features</span><span class="p">,</span>
            <span class="n">sample_roi</span><span class="p">,</span>
            <span class="n">sample_roi_index</span><span class="p">)</span>

        <span class="c1"># ------------------ RPN losses -------------------#
</span>
        <span class="c1">#è¿™æ˜¯å¯¹ä¸€é˜¶æ®µå›å½’çš„åˆ†ç±»å’Œæ ‡ç­¾
</span>        <span class="c1">#è¿™é‡Œä½¿ç”¨çš„æ˜¯å…¨éƒ¨anchorå’Œå¯¹åº”çš„gtæ¥åšæŸå¤±ã€‚
</span>        <span class="n">gt_rpn_loc</span><span class="p">,</span> <span class="n">gt_rpn_label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">anchor_target_creator</span><span class="p">(</span>
            <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">),</span>
            <span class="n">anchor</span><span class="p">,</span>
            <span class="n">img_size</span><span class="p">)</span>
        <span class="n">gt_rpn_label</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">gt_rpn_label</span><span class="p">).</span><span class="nb">long</span><span class="p">()</span>
        <span class="n">gt_rpn_loc</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">gt_rpn_loc</span><span class="p">)</span>
        <span class="n">rpn_loc_loss</span> <span class="o">=</span> <span class="n">_fast_rcnn_loc_loss</span><span class="p">(</span>
            <span class="n">rpn_loc</span><span class="p">,</span>
            <span class="n">gt_rpn_loc</span><span class="p">,</span>
            <span class="n">gt_rpn_label</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">rpn_sigma</span><span class="p">)</span>

        <span class="c1"># NOTE: default value of ignore_index is -100 ...
</span>        <span class="n">rpn_cls_loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">rpn_score</span><span class="p">,</span> <span class="n">gt_rpn_label</span><span class="p">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_gt_rpn_label</span> <span class="o">=</span> <span class="n">gt_rpn_label</span><span class="p">[</span><span class="n">gt_rpn_label</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_rpn_score</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">rpn_score</span><span class="p">)[</span><span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">gt_rpn_label</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">rpn_cm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">_rpn_score</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="n">_gt_rpn_label</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>

        <span class="c1"># ------------------ ROI losses (fast rcnn loss) -------------------#
</span>        <span class="n">n_sample</span> <span class="o">=</span> <span class="n">roi_cls_loc</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roi_cls_loc</span> <span class="o">=</span> <span class="n">roi_cls_loc</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_sample</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">roi_loc</span> <span class="o">=</span> <span class="n">roi_cls_loc</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_sample</span><span class="p">).</span><span class="nb">long</span><span class="p">().</span><span class="n">cuda</span><span class="p">(),</span> \
                              <span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">gt_roi_label</span><span class="p">).</span><span class="nb">long</span><span class="p">()]</span>
        <span class="n">gt_roi_label</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">gt_roi_label</span><span class="p">).</span><span class="nb">long</span><span class="p">()</span>
        <span class="n">gt_roi_loc</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">gt_roi_loc</span><span class="p">)</span>

        <span class="n">roi_loc_loss</span> <span class="o">=</span> <span class="n">_fast_rcnn_loc_loss</span><span class="p">(</span>
            <span class="n">roi_loc</span><span class="p">.</span><span class="n">contiguous</span><span class="p">(),</span>
            <span class="n">gt_roi_loc</span><span class="p">,</span>
            <span class="n">gt_roi_label</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">roi_sigma</span><span class="p">)</span>

        <span class="n">roi_cls_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()(</span><span class="n">roi_score</span><span class="p">,</span> <span class="n">gt_roi_label</span><span class="p">.</span><span class="n">cuda</span><span class="p">())</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">roi_cm</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">roi_score</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="n">gt_roi_label</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>

        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpn_loc_loss</span><span class="p">,</span> <span class="n">rpn_cls_loss</span><span class="p">,</span> <span class="n">roi_loc_loss</span><span class="p">,</span> <span class="n">roi_cls_loss</span><span class="p">]</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">losses</span> <span class="o">+</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">LossTuple</span><span class="p">(</span><span class="o">*</span><span class="n">losses</span><span class="p">)</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸»è¦æµç¨‹æ˜¯ï¼š</p>

<ol>
  <li>é€šè¿‡backboneæå–å•å±‚ç‰¹å¾ï¼Œè¿™å¾ˆç®€å•ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">faster_rcnn</span><span class="p">.</span><span class="n">extractor</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>é€šè¿‡rpnæå–rpn_mapçš„åç§»é‡ï¼Œå¾—åˆ†ï¼Œroiï¼Œroiå¯¹åº”çš„å›¾ç‰‡åºå·ï¼ˆbatchï¼‰ï¼Œä»¥åŠanchorã€‚
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rpn_locs</span><span class="p">,</span> <span class="n">rpn_scores</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">roi_indices</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> \
         <span class="bp">self</span><span class="p">.</span><span class="n">faster_rcnn</span><span class="p">.</span><span class="n">rpn</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>å°†roiè¾“å…¥headä¸­ï¼Œè¿›è¡ŒäºŒæ¬¡å›å½’ã€‚å…¶ä¸­roi_poolingä¹ŸåŒ…å«åœ¨è¿™éƒ¨åˆ†ä¸­ã€‚
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">roi_cls_loc</span><span class="p">,</span> <span class="n">roi_score</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">faster_rcnn</span><span class="p">.</span><span class="n">head</span><span class="p">(</span>
     <span class="n">features</span><span class="p">,</span>
     <span class="n">sample_roi</span><span class="p">,</span>
     <span class="n">sample_roi_index</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>è®¡ç®—åˆ†ç±»å’Œå›å½’ç”¨çš„æ ‡ç­¾ï¼Œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯rpnçš„ï¼Œä¸€éƒ¨åˆ†æ˜¯headçš„ã€‚</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#è¿™æ˜¯å¯¹ä¸€é˜¶æ®µå›å½’çš„åˆ†ç±»å’Œæ ‡ç­¾
#è¿™é‡Œä½¿ç”¨çš„æ˜¯å…¨éƒ¨anchorå’Œå¯¹åº”çš„gtæ¥åšæŸå¤±ã€‚
</span><span class="n">gt_rpn_loc</span><span class="p">,</span> <span class="n">gt_rpn_label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">anchor_target_creator</span><span class="p">(</span>
            <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">),</span>
            <span class="n">anchor</span><span class="p">,</span>
            <span class="n">img_size</span><span class="p">)</span>

<span class="c1"># è¿”å›å€¼ roi æŒ‰æŒ‡å®šæ•°é‡å’Œæ¯”ä¾‹é‡‡æ ·çš„æ­£è´Ÿæ ·æœ¬ï¼Œå¯¹åº”çš„çœŸå€¼åç§»ï¼Œä»¥åŠä»–ä»¬çš„labelã€‚
# è¿™é‡Œè®¡ç®—å‡ºæ¥çš„gtæ˜¯é’ˆå¯¹roiçš„åç§»å’Œæ ‡ç­¾ï¼Œå³è¿™æ˜¯å¯¹äºŒé˜¶æ®µå›å½’å’Œåˆ†ç±»çš„æ ‡ç­¾
</span><span class="n">sample_roi</span><span class="p">,</span> <span class="n">gt_roi_loc</span><span class="p">,</span> <span class="n">gt_roi_label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">proposal_target_creator</span><span class="p">(</span>
            <span class="n">roi</span><span class="p">,</span>
            <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">bbox</span><span class="p">),</span>
            <span class="n">at</span><span class="p">.</span><span class="n">tonumpy</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">loc_normalize_mean</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">loc_normalize_std</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>è®¡ç®—æŸå¤±ï¼Œè¿™éƒ¨åˆ†å¾ˆç®€å•ï¼Œä¸¤ä¸ªäº¤å‰ç†µç”¨äºåˆ†ç±»ï¼Œä¸¤ä¸ªsmoothL1ç”¨äºå›å½’ã€‚</li>
</ol>

<p>é¦–å…ˆï¼Œè§£æä¸€ä¸‹ <strong>rpn</strong> æ¨¡å—ã€‚rpnæ¨¡å—ä¸­åŒ…æ‹¬äº†anchorçš„ç”Ÿæˆä»¥åŠå¯¹åº”åç§»é‡çš„è®¡ç®—ã€‚å…¶åœ¨æ–‡ä»¶ <strong>/model/region_proposal_network.py</strong> ä¸­ã€‚</p>

<p>çœ‹ä¸€ä¸‹ä»–çš„forwardå‡½æ•°</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="s">"""Forward Region Proposal Network.

        Here are notations.

        * :math:`N` is batch size.
        * :math:`C` channel size of the input.
        * :math:`H` and :math:`W` are height and witdh of the input feature.
        * :math:`A` is number of anchors assigned to each pixel.

        Args:
            x (~torch.autograd.Variable): The Features extracted from images.
                Its shape is :math:`(N, C, H, W)`.
            img_size (tuple of ints): A tuple :obj:`height, width`,
                which contains image size after scaling.
            scale (float): The amount of scaling done to the input images after
                reading them from files.

        Returns:
            (~torch.autograd.Variable, ~torch.autograd.Variable, array, array, array):

            This is a tuple of five following values.

            * **rpn_locs**: Predicted bounding box offsets and scales for </span><span class="se">\
</span><span class="s">                anchors. Its shape is :math:`(N, H W A, 4)`.
            * **rpn_scores**:  Predicted foreground scores for </span><span class="se">\
</span><span class="s">                anchors. Its shape is :math:`(N, H W A, 2)`.
            * **rois**: A bounding box array containing coordinates of </span><span class="se">\
</span><span class="s">                proposal boxes.  This is a concatenation of bounding box </span><span class="se">\
</span><span class="s">                arrays from multiple images in the batch. </span><span class="se">\
</span><span class="s">                Its shape is :math:`(R', 4)`. Given :math:`R_i` predicted </span><span class="se">\
</span><span class="s">                bounding boxes from the :math:`i` th image, </span><span class="se">\
</span><span class="s">                :math:`R' = </span><span class="se">\\</span><span class="s">sum _{i=1} ^ N R_i`.
            * **roi_indices**: An array containing indices of images to </span><span class="se">\
</span><span class="s">                which RoIs correspond to. Its shape is :math:`(R',)`.
            * **anchor**: Coordinates of enumerated shifted anchors. </span><span class="se">\
</span><span class="s">                Its shape is :math:`(H W A, 4)`.

        """</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ww</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="n">_enumerate_shifted_anchor</span><span class="p">(</span>
            <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">anchor_base</span><span class="p">),</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">feat_stride</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ww</span><span class="p">)</span>

        <span class="c1">#æ¯ä¸ªcellå¤„anchorçš„æ•°é‡
</span>        <span class="n">n_anchor</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="n">hh</span> <span class="o">*</span> <span class="n">ww</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">rpn_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">loc</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="c1"># UNNOTE: check whether need contiguous
</span>        <span class="c1"># A: Yes
</span>        <span class="n">rpn_locs</span> <span class="o">=</span> <span class="n">rpn_locs</span><span class="p">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">contiguous</span><span class="p">().</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">rpn_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">rpn_scores</span> <span class="o">=</span> <span class="n">rpn_scores</span><span class="p">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="c1">#è®¡ç®—softmaxåˆ†ç±»ç»“æœ
</span>        <span class="n">rpn_softmax_scores</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">rpn_scores</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ww</span><span class="p">,</span> <span class="n">n_anchor</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1">#æå–å‰æ™¯å¾—åˆ†
</span>        <span class="n">rpn_fg_scores</span> <span class="o">=</span> <span class="n">rpn_softmax_scores</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">].</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">rpn_fg_scores</span> <span class="o">=</span> <span class="n">rpn_fg_scores</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rpn_scores</span> <span class="o">=</span> <span class="n">rpn_scores</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">rois</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">roi_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1">#å¯¹æ¯å¼ å›¾çš„roiè¿›è¡Œç­›é€‰é‡‡æ ·ï¼Œé€‰å–æŒ‡å®šæ•°é‡çš„roiï¼Œå†ç»è¿‡nmsï¼Œä¿ç•™æŒ‡å®šæ•°é‡çš„roi
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">proposal_layer</span><span class="p">(</span>
                <span class="n">rpn_locs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu</span><span class="p">().</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">rpn_fg_scores</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu</span><span class="p">().</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">anchor</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">rois</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">roi_indices</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_index</span><span class="p">)</span>

        <span class="n">rois</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">roi_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">roi_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#è¿”å›å€¼ä¾æ¬¡æ˜¯
</span>        <span class="c1">#rpnåç§»é‡ï¼Œå¾—åˆ†ï¼Œroi(è§’åæ ‡)ï¼Œroiå¯¹åº”çš„å›¾ç‰‡(åœ¨batchä¸­çš„åºå·)ï¼Œanchor
</span>        <span class="k">return</span> <span class="n">rpn_locs</span><span class="p">,</span> <span class="n">rpn_scores</span><span class="p">,</span> <span class="n">rois</span><span class="p">,</span> <span class="n">roi_indices</span><span class="p">,</span> <span class="n">anchor</span>
</code></pre></div></div>

<p>ä¸»è¦åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤</p>

<ol>
  <li>å»ºç«‹anchorï¼šé€šè¿‡<strong>_enumerate_shifted_anchor</strong>å‡½æ•°å»ºç«‹ï¼Œä¹‹åå°†å…¶å±•å¼€ä¸ºäºŒç»´æ•°ç»„è¿”å›ã€‚è¿™éƒ¨åˆ†ç›¸å¯¹ç®€å•ï¼Œå¦‚ä¸‹ã€‚anchor_basedä»£è¡¨ä¸€ä¸ªcellä¸Šçš„å¤šé‡anchorå¤§å°ä¿¡æ¯ï¼Œä¾æ¬¡åŠ ä¸Šåç§»å°±å¾—åˆ°æœ€ç»ˆçš„anchorä¿¡æ¯ã€‚</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_enumerate_shifted_anchor_torch</span><span class="p">(</span><span class="n">anchor_base</span><span class="p">,</span> <span class="n">feat_stride</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="c1"># Enumerate all shifted anchors:
</span>    <span class="c1">#
</span>    <span class="c1"># add A anchors (1, A, 4) to
</span>    <span class="c1"># cell K shifts (K, 1, 4) to get
</span>    <span class="c1"># shift anchors (K, A, 4)
</span>    <span class="c1"># reshape to (K*A, 4) shifted anchors
</span>    <span class="c1"># return (K*A, 4)
</span>
    <span class="c1"># !TODO: add support for torch.CudaTensor
</span>    <span class="c1"># xp = cuda.get_array_module(anchor_base)
</span>    <span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="n">t</span>
    <span class="n">shift_y</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="n">feat_stride</span><span class="p">,</span> <span class="n">feat_stride</span><span class="p">)</span>
    <span class="n">shift_x</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">feat_stride</span><span class="p">,</span> <span class="n">feat_stride</span><span class="p">)</span>

    <span class="c1">#æ³¨æ„é¡ºåºï¼Œè¿™é‡Œéœ€è¦ä»¥è¡Œä¼˜å…ˆå±•å¼€ï¼Œè¿™æ ·æ‰èƒ½å’Œç½‘ç»œé¢„æµ‹ç»“æœçš„å±•å¼€æ–¹å¼å¯¹åº”ä¸Š
</span>    <span class="c1">#å› ä¸ºç½‘ç»œé¢„æµ‹ç»“æœçš„å¤§å°æ˜¯[batch,h,w,A,4],å› æ­¤å±•å¼€æ—¶ä¼šå…ˆæŒ‰wå±•å¼€ï¼Œå†æŒ‰hå±•å¼€
</span>    <span class="c1">#å³å…ˆå±•å¼€æ¨ªåæ ‡xï¼ˆåˆ—ï¼‰,å†å±•å¼€çºµåæ ‡yï¼ˆè¡Œï¼‰ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæ˜¯åŒæ ·çš„æ–¹å¼ï¼Œå…ˆå±•å¼€xï¼Œå†å±•å¼€y
</span>    <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span> <span class="o">=</span> <span class="n">xp</span><span class="p">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">xp</span><span class="p">.</span><span class="n">stack</span><span class="p">((</span><span class="n">shift_y</span><span class="p">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">shift_x</span><span class="p">.</span><span class="n">ravel</span><span class="p">(),</span>
                      <span class="n">shift_y</span><span class="p">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">shift_x</span><span class="p">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">anchor_base</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">shift</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor_base</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> \
             <span class="n">shift</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">4</span><span class="p">)).</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">K</span> <span class="o">*</span> <span class="n">A</span><span class="p">,</span> <span class="mi">4</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">anchor</span>
</code></pre></div></div>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„x y å±•å¼€é¡ºåºï¼Œ<strong>shift_x, shift_y = xp.meshgrid(shift_x, shift_y)</strong>ã€‚<strong>ä¸€å®šæ˜¯å…ˆå±•å¼€xåæ ‡ï¼Œå³çŸ©é˜µçš„åˆ—åæ ‡ï¼Œå†å±•å¼€yåæ ‡ï¼Œå³çŸ©é˜µçš„è¡Œåæ ‡ã€‚è¿™æ ·æ˜¯æŒ‰è¡Œå±•å¼€çš„æ¨¡å¼ï¼Œæ‰å¯ä»¥å’Œç½‘ç»œé¢„æµ‹çš„ç»“æœå±•å¼€åï¼ˆtorchéƒ½æ˜¯è¡Œä¼˜å…ˆå±•å¼€ï¼‰çš„ç»“æœå¯¹åº”ã€‚</strong></p>

<ol>
  <li>ç”Ÿæˆç½‘ç»œçš„é¢„æµ‹ç»“æœï¼Œå¹¶å±•å¼€æˆäºŒç»´æ•°ç»„å½¢å¼ã€‚é¢„æµ‹ç»“æœåŒ…æ‹¬rpn_locsåç§»é‡ï¼Œä»¥åŠrpn_scoreså¾—åˆ†ï¼Œå¹¶é€šè¿‡softmaxå‡½æ•°åˆ¤æ–­å‰æ™¯ç½®ä¿¡åº¦ã€‚</li>
  <li>å¯¹batchä¸­çš„æ¯å¼ å›¾ç‰‡ï¼Œäº§ç”Ÿproposal</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#å¯¹æ¯å¼ å›¾çš„roiè¿›è¡Œç­›é€‰é‡‡æ ·ï¼Œé€‰å–æŒ‡å®šæ•°é‡çš„roiï¼Œå†ç»è¿‡nmsï¼Œä¿ç•™æŒ‡å®šæ•°é‡çš„roi
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">proposal_layer</span><span class="p">(</span>
                <span class="n">rpn_locs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu</span><span class="p">().</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">rpn_fg_scores</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpu</span><span class="p">().</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">anchor</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">batch_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">rois</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">roi_indices</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_index</span><span class="p">)</span>
</code></pre></div></div>

<p>æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°proposal_layerå¯¹åº”çš„æ˜¯<strong>ProposalCreator</strong>ç±»ï¼Œ__call__æ–¹æ³•ä»£ç å¦‚ä¸‹</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span>
                 <span class="n">anchor</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="s">"""input should  be ndarray
        Propose RoIs.

        Inputs :obj:`loc, score, anchor` refer to the same anchor when indexed
        by the same index.

        On notations, :math:`R` is the total number of anchors. This is equal
        to product of the height and the width of an image and the number of
        anchor bases per pixel.

        Type of the output is same as the inputs.

        Args:
            loc (array): Predicted offsets and scaling to anchors.
                Its shape is :math:`(R, 4)`.
            score (array): Predicted foreground probability for anchors.
                Its shape is :math:`(R,)`.
            anchor (array): Coordinates of anchors. Its shape is
                :math:`(R, 4)`.
            img_size (tuple of ints): A tuple :obj:`height, width`,
                which contains image size after scaling.
            scale (float): The scaling factor used to scale an image after
                reading it from a file.

        Returns:
            array:
            An array of coordinates of proposal boxes.
            Its shape is :math:`(S, 4)`. :math:`S` is less than
            :obj:`self.n_test_post_nms` in test time and less than
            :obj:`self.n_train_post_nms` in train time. :math:`S` depends on
            the size of the predicted bounding boxes and the number of
            bounding boxes discarded by NMS.

        """</span>
        <span class="c1"># NOTE: when test, remember
</span>        <span class="c1"># faster_rcnn.eval()
</span>        <span class="c1"># to set self.traing = False
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">parent_model</span><span class="p">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">n_pre_nms</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_train_pre_nms</span>
            <span class="n">n_post_nms</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_train_post_nms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_pre_nms</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_test_pre_nms</span>
            <span class="n">n_post_nms</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_test_post_nms</span>

        <span class="c1"># Convert anchors into proposal via bbox transformations.
</span>        <span class="c1"># roi = loc2bbox(anchor, loc)
</span>
        <span class="c1">#åç§»è½¬æ¢ä¸º ymin xmin ymax xmax
</span>        <span class="n">roi</span> <span class="o">=</span> <span class="n">loc2bbox</span><span class="p">(</span><span class="n">anchor</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>

        <span class="c1"># Clip predicted boxes to image.
</span>        <span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Remove predicted boxes with either height or width &lt; threshold.
</span>        <span class="c1"># é™¤å»è¿‡å°çš„roi
</span>        <span class="n">min_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">min_size</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">hs</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ws</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">keep</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>

        <span class="c1"># Sort all (proposal, score) pairs by score from highest to lowest.
</span>        <span class="c1"># Take top pre_nms_topN (e.g. 6000).
</span>
        <span class="c1">#é€‰æ‹©åˆ†æ•°æœ€å¤§Nä¸ªroi,è€Œä¸æ˜¯ç”¨é˜ˆå€¼åˆ¤æ–­ã€‚
</span>        <span class="n">order</span> <span class="o">=</span> <span class="n">score</span><span class="p">.</span><span class="n">ravel</span><span class="p">().</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_pre_nms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">[:</span><span class="n">n_pre_nms</span><span class="p">]</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

        <span class="c1"># Apply nms (e.g. threshold = 0.7).
</span>        <span class="c1"># Take after_nms_topN (e.g. 300).
</span>
        <span class="c1"># unNOTE: somthing is wrong here!
</span>        <span class="c1"># TODO: remove cuda.to_gpu
</span>        <span class="n">keep</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">roi</span><span class="p">).</span><span class="n">cuda</span><span class="p">(),</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">score</span><span class="p">).</span><span class="n">cuda</span><span class="p">(),</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">nms_thresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_post_nms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span><span class="p">[:</span><span class="n">n_post_nms</span><span class="p">]</span> <span class="c1">#åœ¨nmsåä¿ç•™è‡³å¤šæŒ‡å®šæ•°é‡çš„roi
</span>

        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">keep</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">roi</span>
</code></pre></div></div>

<p>å…¶å…·ä½“å†…å®¹å°±æ˜¯ï¼š</p>

<ul>
  <li>å°†roiçš„ xywhæ ¼å¼è½¬æ¢ä¸ºymin xmin ymax xmaxæ ¼å¼ï¼Œå¹¶ç­›é™¤å¤§å°å¤ªå°çš„roiï¼›</li>
  <li>å°†roisçš„ç½®ä¿¡åº¦æ’åºï¼Œé€‰æ‹©å‰Nä¸ªroisï¼Œè¿™ä¸ªæ•°é‡ç”±<strong>n_pre_nms</strong>å†³å®šï¼Œç¨‹åºä¸­è®¾å®šçš„æ˜¯12000ï¼›</li>
  <li>å°†è¿™äº›roisåšnmsï¼Œä¹‹åå†ä¿ç•™è‡³å¤š<strong>n_post_nms</strong>ä¸ªroiï¼Œè¿™é‡Œç¨‹åºä¸­è®¾å®šçš„æ˜¯6000ï¼›</li>
  <li>è¿”å›ä¸Šè¿°ç»è¿‡ç­›é€‰çš„roisã€‚</li>
</ul>

<p>4.è¿”å›è¿™äº›proposalã€‚</p>

<p>äº†è§£å®Œrpnæ¨¡å—ï¼Œå†ç»§ç»­å¾€ä¸‹çœ‹ï¼Œä¸‹ä¸€æ­¥æ˜¯headæ¨¡å—ã€‚è¿™ä¸ªæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„ï¼Œå› ä¸ºå…¶åªæ˜¯æ¥å—äº†roisï¼Œå’Œå…¶å¯¹åº”çš„indeceï¼Œåœ¨å¯¹åº”çš„å›¾ç‰‡çš„feature_mapä¸Šåšroi_poolingï¼Œç„¶åç»è¿‡ä¸€ä¸ªheadç½‘ç»œè¾“å‡ºå³å¯ã€‚</p>

<p>ä¹‹åæ¥çœ‹ä¸€ä¸‹rpnå’Œ headçš„targetéƒ½æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚rpnçš„targetçš„ç”Ÿæˆåœ¨ç¨‹åºä¸­æ˜¯é€šè¿‡<strong>anchor_target_creator()</strong>å®ç°çš„ã€‚å…¶<strong>__call__()</strong>æ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯<strong>_create_label()ï¼Œ_cal_ious()</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">_create_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inside_index</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">bbox</span><span class="p">):</span>
        <span class="c1">#æ­¤æ—¶çš„anchorå·²ç»æ˜¯å’Œinside_indexä¸€æ ·é•¿åº¦çš„äº†ï¼Œå³å·²ç»ç­›é™¤äº†è¶Šç•Œçš„anchor
</span>        <span class="c1"># label: 1 is positive, 0 is negative, -1 is dont care
</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">inside_index</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">label</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">argmax_ious</span><span class="p">,</span> <span class="n">max_ious</span><span class="p">,</span> <span class="n">gt_argmax_ious</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="p">.</span><span class="n">_calc_ious</span><span class="p">(</span><span class="n">anchor</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">inside_index</span><span class="p">)</span>

        <span class="c1"># assign negative labels first so that positive labels can clobber them
</span>        <span class="n">label</span><span class="p">[</span><span class="n">max_ious</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">neg_iou_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#iouå°äºé˜ˆå€¼çš„è®¾ä¸ºè´Ÿæ ·æœ¬
</span>
        <span class="c1"># positive label: for each gt, anchor with highest iou
</span>        <span class="n">label</span><span class="p">[</span><span class="n">gt_argmax_ious</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1">#æœ€åŒ¹é…çš„anchorè®¾ä¸ºæ­£æ ·æœ¬
</span>
        <span class="c1"># positive label: above threshold IOU
</span>        <span class="n">label</span><span class="p">[</span><span class="n">max_ious</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos_iou_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#å…¶ä½™å¤§äºé˜ˆå€¼çš„anchorsä¹Ÿè®¾ä¸ºæ­£æ ·æœ¬
</span>
        <span class="c1">#æ­£è´Ÿæ ·æœ¬æŒ‰æ¯”ä¾‹é‡‡æ ·
</span>        <span class="c1">#å…·ä½“æ–¹æ³•ï¼Œå†ä¸Šè¿°å·²ç»ç»™å®šçš„æ ‡ç­¾åŸºç¡€ä¸Šï¼Œå°†ä¸é‡‡æ ·çš„æ•°æ®è®¾ä¸º-1 don't care
</span>        <span class="c1"># subsample positive labels if we have too many
</span>        <span class="n">n_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pos_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_sample</span><span class="p">)</span>
        <span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_pos</span><span class="p">:</span>
            <span class="n">disable_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">pos_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_index</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_pos</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">label</span><span class="p">[</span><span class="n">disable_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># subsample negative labels if we have too many
</span>        <span class="n">n_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_sample</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_neg</span><span class="p">:</span>
            <span class="n">disable_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">neg_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_index</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_neg</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">label</span><span class="p">[</span><span class="n">disable_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">argmax_ious</span><span class="p">,</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">_calc_ious</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">inside_index</span><span class="p">):</span>
    <span class="c1"># æ­¤æ—¶çš„anchorå·²ç»æ˜¯å’Œinside_indexä¸€æ ·é•¿åº¦çš„äº†ï¼Œå³å·²ç»ç­›é™¤äº†è¶Šç•Œçš„anchor
</span>    <span class="c1"># ious between the anchors and the gt boxes
</span>    <span class="n">ious</span> <span class="o">=</span> <span class="n">bbox_iou</span><span class="p">(</span><span class="n">anchor</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
    <span class="n">argmax_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#æ‰¾åˆ°æ¯ä¸ªanchor iouæœ€å¤§çš„gt box
</span>    <span class="n">max_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inside_index</span><span class="p">)),</span> <span class="n">argmax_ious</span><span class="p">]</span> <span class="c1">#å¾—åˆ°æ¯ä¸ªanchorå¯¹åº”çš„æœ€å¤§iou
</span>    <span class="n">gt_argmax_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#å¾—åˆ°æ¯ä¸ªgtæœ€åŒ¹é…çš„anchor
</span>    <span class="n">gt_max_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="p">[</span><span class="n">gt_argmax_ious</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ious</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="c1">#gtæœ€åŒ¹é…anchorçš„iou
</span>    <span class="n">gt_argmax_ious</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">ious</span> <span class="o">==</span> <span class="n">gt_max_ious</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#å¾—åˆ°ç›¸äº’æœ€åŒ¹é…çš„gt anchorå¯¹
</span>
    <span class="k">return</span> <span class="n">argmax_ious</span><span class="p">,</span> <span class="n">max_ious</span><span class="p">,</span> <span class="n">gt_argmax_ious</span>
</code></pre></div></div>

<p>å…¶åŠŸèƒ½åœ¨ä¸Šè¿°æ³¨é‡Šä¸­å·²ç»å†™å¾—æ¯”è¾ƒè¯¦ç»†ï¼Œåˆ†é…åŸåˆ™å¦‚ä¸‹ï¼š</p>
<ul>
  <li>è®¡ç®—anchorå’Œgt_bboxä¹‹é—´çš„iouï¼Œåˆ†åˆ«å¾—åˆ°
    <ul>
      <li>æ¯ä¸ªanchorå¯¹åº”çš„iouæœ€å¤§çš„gt_bboxåºå·ï¼Œ<strong>argmax_ious</strong></li>
      <li>ä¸Šä¸€æ¡å¯¹åº”çš„iouï¼Œ<strong>max_ious</strong></li>
      <li>æ¯ä¸ªgt_bboxå¯¹åº”çš„iouæœ€å¤§çš„anchoråºå·ï¼Œ<strong>gt_argmax_ious</strong></li>
      <li>ä¸Šä¸€æ¡å¯¹åº”çš„iouï¼Œ<strong>gt_argmax_ious</strong></li>
    </ul>
  </li>
  <li>ä¸ºanchoråˆ†é…class labelå’Œtargetï¼ŒåŸåˆ™å¦‚ä¸‹
    <ul>
      <li>æ¯ä¸ªgt_bboxè‡³å°‘æœ‰ä¸€ä¸ªanchorè·Ÿå®ƒå¯¹åº”ï¼Œå³å’Œgt_bboxé‡å æœ€å¤§çš„é‚£ä¸ªã€‚</li>
      <li>æ¯ä¸ªanchoréƒ½è¢«åˆ’åˆ†åˆ°ä¸å…¶iouæœ€å¤§çš„gt_bboxä¸Šï¼Œiouå°äºé˜ˆå€¼åˆ™ä¸ºè´Ÿï¼Œå¤§äºä¸ºæ­£</li>
      <li>æ ¹æ®ä¸Šä¸€æ¡çš„å¯¹åº”å…³ç³»è®¡ç®—åå·® xywh</li>
      <li>æ ¹æ®äº‹å…ˆç»™å®šçš„é‡‡æ ·æ•°é‡å’Œæ­£è´Ÿæ ·æœ¬æ¯”ä¾‹ï¼Œä»ä¸Šè¿°æ ·æœ¬ä¸­éšæœºæŠ½å–æŒ‡å®šæ•°é‡å’Œæ¯”ä¾‹çš„æ­£è´Ÿæ ·æœ¬ã€‚å…¶ä½™æ ·æœ¬çš„labelå…¨éƒ¨è®¾ç½®ä¸º-1(donâ€™t care)</li>
    </ul>
  </li>
</ul>

<p>è¿™å°±å®Œæˆäº†rpn targetçš„è®¡ç®—ï¼Œä¹‹åç›´æ¥å¥—ç”¨æŸå¤±å‡½æ•°å³å¯ã€‚</p>

<p>headçš„targetåˆ™ä½¿ç”¨<strong>ProposalTargetCreator()</strong>ç±»æ¥å®ç°ï¼Œå…¶åŸç†å’Œä¸Šé¢ç±»ä¼¼ï¼Œä½†æ˜¯æ›´ç®€å•ã€‚åŒæ ·å¯¹æ¯ä¸ªroiséƒ½é€šè¿‡iouå’Œä¸€ä¸ªgt_bboxå¯¹åº”èµ·æ¥ï¼Œå†æ ¹æ®iouåˆ¤æ–­pos or neg ä»¥åŠæ ¹æ®å¯¹åº”å…³ç³»è®¡ç®—åå·®å³å¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                 <span class="n">loc_normalize_mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                 <span class="n">loc_normalize_std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)):</span>
        <span class="s">"""Assigns ground truth to sampled proposals.

        This function samples total of :obj:`self.n_sample` RoIs
        from the combination of :obj:`roi` and :obj:`bbox`.
        The RoIs are assigned with the ground truth class labels as well as
        bounding box offsets and scales to match the ground truth bounding
        boxes. As many as :obj:`pos_ratio * self.n_sample` RoIs are
        sampled as foregrounds.

        ROIè¢«èµ‹äºˆçœŸå€¼ï¼ŒåŒ…æ‹¬gt claseeå’Œboounding boxçš„offset å’Œscaleæ¥åŒ¹é…gt bounding boxã€‚
        pos_ratio * self.n_sampleä¸ªroiä¼šè¢«é‡‡æ ·ä¸ºæ­£æ ·æœ¬ã€‚

        Offsets and scales of bounding boxes are calculated using
        :func:`model.utils.bbox_tools.bbox2loc`.
        Also, types of input arrays and output arrays are same.

        Here are notations.

        * :math:`S` is the total number of sampled RoIs, which equals </span><span class="se">\
</span><span class="s">            :obj:`self.n_sample`.
        * :math:`L` is number of object classes possibly including the </span><span class="se">\
</span><span class="s">            background.

        Args:
            roi (array): Region of Interests (RoIs) from which we sample.
                Its shape is :math:`(R, 4)`
            bbox (array): The coordinates of ground truth bounding boxes.
                Its shape is :math:`(R', 4)`.
            label (array): Ground truth bounding box labels. Its shape
                is :math:`(R',)`. Its range is :math:`[0, L - 1]`, where
                :math:`L` is the number of foreground classes.
            loc_normalize_mean (tuple of four floats): Mean values to normalize
                coordinates of bouding boxes.
            loc_normalize_std (tupler of four floats): Standard deviation of
                the coordinates of bounding boxes.


        Returns:
            (array, array, array):

            * **sample_roi**: Regions of interests that are sampled. </span><span class="se">\
</span><span class="s">                Its shape is :math:`(S, 4)`.
            * **gt_roi_loc**: Offsets and scales to match </span><span class="se">\
</span><span class="s">                the sampled RoIs to the ground truth bounding boxes. </span><span class="se">\
</span><span class="s">                Its shape is :math:`(S, 4)`.
            * **gt_roi_label**: Labels assigned to sampled RoIs. Its shape is </span><span class="se">\
</span><span class="s">                :math:`(S,)`. Its range is :math:`[0, L]`. The label with </span><span class="se">\
</span><span class="s">                value 0 is the background.

        """</span>
        <span class="n">n_bbox</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">.</span><span class="n">shape</span>

        <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">roi</span><span class="p">,</span> <span class="n">bbox</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">pos_roi_per_image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">n_sample</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos_ratio</span><span class="p">)</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="n">bbox_iou</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>  <span class="c1"># [R,R']
</span>        <span class="n">gt_assignment</span> <span class="o">=</span> <span class="n">iou</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#æ¯ä¸ªroiä»…åˆ†é…ä¸€ä¸ªçœŸå€¼ï¼Œå³å’Œå…¶roiæœ€å¤§çš„gtboxå…³è”èµ·æ¥ã€‚
</span>        <span class="n">max_iou</span> <span class="o">=</span> <span class="n">iou</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Offset range of classes from [0, n_fg_class - 1] to [1, n_fg_class].
</span>        <span class="c1"># The label with value 0 is the background.
</span>        <span class="n">gt_roi_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">gt_assignment</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">#å¾—åˆ°æ¯ä¸ªroiå¯¹åº”çš„ç±»åˆ«
</span>
        <span class="c1"># Select foreground RoIs as those with &gt;= pos_iou_thresh IoU.
</span>        <span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_iou</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos_iou_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#é€‰æ‹©æœ€å¤§iouå¤§äºthresholdçš„roiä½œä¸ºæ­£æ ·æœ¬
</span>        <span class="n">pos_roi_per_this_image</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pos_roi_per_image</span><span class="p">,</span> <span class="n">pos_index</span><span class="p">.</span><span class="n">size</span><span class="p">))</span> <span class="c1">#å¦‚æœposæ•°é‡æ²¡æœ‰é¢„å®šçš„é‡‡æ ·æ•°é‡å¤šï¼Œåˆ™ä¿®æ”¹é‡‡æ ·æ•°é‡
</span>        <span class="k">if</span> <span class="n">pos_index</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">pos_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pos_roi_per_this_image</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># Select background RoIs as those within
</span>        <span class="c1"># [neg_iou_thresh_lo, neg_iou_thresh_hi).
</span>        <span class="n">neg_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">max_iou</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">neg_iou_thresh_hi</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">max_iou</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">neg_iou_thresh_lo</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#ç­›é€‰è´Ÿæ ·æœ¬ï¼Œå…¶ä¸­è®¾ç½®äº†è´Ÿæ ·æœ¬iouçš„ä¸Šé™å’Œä¸‹çº¿
</span>        <span class="n">neg_roi_per_this_image</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_sample</span> <span class="o">-</span> <span class="n">pos_roi_per_this_image</span> <span class="c1">#å†³å®šè´Ÿæ ·æœ¬çš„é‡‡æ ·æ•°é‡
</span>        <span class="n">neg_roi_per_this_image</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">neg_roi_per_this_image</span><span class="p">,</span>
                                         <span class="n">neg_index</span><span class="p">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">neg_index</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">neg_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">neg_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">neg_roi_per_this_image</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># The indices that we're selecting (both positive and negative).
</span>        <span class="n">keep_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_index</span><span class="p">,</span> <span class="n">neg_index</span><span class="p">)</span>               <span class="c1">#catä¸¤è€…çš„Index
</span>        <span class="n">gt_roi_label</span> <span class="o">=</span> <span class="n">gt_roi_label</span><span class="p">[</span><span class="n">keep_index</span><span class="p">]</span>                    <span class="c1">#å¾—åˆ°å¯¹åº”çš„ç±»åˆ«
</span>        <span class="n">gt_roi_label</span><span class="p">[</span><span class="n">pos_roi_per_this_image</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># negative labels --&gt; 0 è´Ÿæ ·æœ¬æ ‡ç­¾æ›´æ”¹ä¸ºèƒŒæ™¯
</span>        <span class="n">sample_roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">keep_index</span><span class="p">]</span>

        <span class="c1"># Compute offsets and scales to match sampled RoIs to the GTs.
</span>        <span class="n">gt_roi_loc</span> <span class="o">=</span> <span class="n">bbox2loc</span><span class="p">(</span><span class="n">sample_roi</span><span class="p">,</span> <span class="n">bbox</span><span class="p">[</span><span class="n">gt_assignment</span><span class="p">[</span><span class="n">keep_index</span><span class="p">]])</span>  <span class="c1">#è®¡ç®—target
</span>        <span class="n">gt_roi_loc</span> <span class="o">=</span> <span class="p">((</span><span class="n">gt_roi_loc</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">loc_normalize_mean</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
                       <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">loc_normalize_std</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">))</span>   <span class="c1">#å¯¹è®¡ç®—å‡ºæ¥çš„åç§»é‡å†åšä¸€æ¬¡å½’ä¸€åŒ–
</span>
        <span class="c1"># è¿”å›å€¼ roi æŒ‰æŒ‡å®šæ•°é‡å’Œæ¯”ä¾‹é‡‡æ ·çš„æ­£è´Ÿæ ·æœ¬ï¼Œå¯¹åº”çš„çœŸå€¼åç§»ï¼Œä»¥åŠä»–ä»¬çš„labelã€‚
</span>        <span class="k">return</span> <span class="n">sample_roi</span><span class="p">,</span> <span class="n">gt_roi_loc</span><span class="p">,</span> <span class="n">gt_roi_label</span>
</code></pre></div></div>

<p>ä¹‹ååšæ­£åä¼ æ’­å°±å¯ä»¥è®­ç»ƒç½‘ç»œäº†ï¼ä»£ç è§£ææ¥åˆ°è¿™é‡Œã€‚</p>

:ET